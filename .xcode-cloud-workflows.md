# Xcode Cloud Workflows for Nestory-Pro

## Workflow 1: Pull Request Validation
**Purpose:** Validate all PRs before merge

**Start Condition:**
- Pull Request opened
- Pull Request updated

**Environment:**
- Xcode: Latest Release
- macOS: Latest

**Actions:**
1. Build for Testing (Nestory-Pro scheme)
2. Test - iPhone 17 Pro Max (iOS 18.0)
3. Test - iPhone SE 3rd Gen (iOS 17.0)
4. Analyze (Static Analysis)

**Post-Actions:**
- Notify team if tests fail
- Post status to GitHub PR

**Estimated Compute Time:** ~15-20 minutes per run

---

## Workflow 2: Main Branch - Build & Test
**Purpose:** Validate main branch integrity after merge

**Start Condition:**
- Branch: main
- On push

**Environment:**
- Xcode: Latest Release
- macOS: Latest

**Actions:**
1. Build for Testing (Nestory-Pro scheme)
2. Test - iPhone 17 Pro Max (iOS 18.0)
3. Test - iPhone 15 Pro (iOS 17.0)
4. Test - iPad Pro 12.9" (iOS 18.0)
5. Archive (Nestory-Pro-Beta scheme)

**Post-Actions:**
- Deploy to TestFlight (Internal Testing)
- Notify team on success/failure
- Tag release if all pass

**Estimated Compute Time:** ~25-30 minutes per run

---

## Workflow 3: Nightly Build
**Purpose:** Comprehensive testing across all devices

**Start Condition:**
- Schedule: Every day at 2:00 AM UTC

**Environment:**
- Xcode: Latest Release
- macOS: Latest

**Actions:**
1. Build for Testing (Nestory-Pro scheme)
2. Test - iPhone 17 Pro Max (iOS 18.0)
3. Test - iPhone 17 Pro (iOS 18.0)
4. Test - iPhone 15 (iOS 17.0)
5. Test - iPhone SE 3rd Gen (iOS 17.0)
6. Test - iPad Pro 12.9" (iOS 18.0)
7. Test - iPad Air (iOS 17.0)
8. Run Performance Tests
9. Archive (Beta)

**Post-Actions:**
- Generate test coverage report
- Deploy to TestFlight (Internal)
- Send detailed report to team

**Estimated Compute Time:** ~45-60 minutes per run

---

## Workflow 4: Release Build
**Purpose:** Production release to App Store

**Start Condition:**
- Tag: v*.*.*
- Manual trigger

**Environment:**
- Xcode: Latest Release
- macOS: Latest

**Actions:**
1. Build for Testing
2. Test - All supported devices
3. Archive (Nestory-Pro-Release scheme)

**Post-Actions:**
- Deploy to TestFlight (External Testing)
- Submit for App Store Review (optional)
- Create GitHub Release
- Notify stakeholders

**Estimated Compute Time:** ~30-40 minutes per run

---

## Custom Build Scripts

### ci_scripts/ci_post_clone.sh
Runs after Xcode Cloud clones the repository:
```bash
#!/bin/sh
set -e

echo "Installing dependencies..."

# Install Bundler gems (Fastlane)
if [ -f "Gemfile" ]; then
    bundle install
fi

# Additional setup can go here
echo "Post-clone setup complete"
```

### ci_scripts/ci_pre_xcodebuild.sh
Runs before xcodebuild:
```bash
#!/bin/sh
set -e

echo "Pre-build setup..."

# Example: Generate build number from commit count
# BUILD_NUMBER=$(git rev-list --count HEAD)
# /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" "Nestory-Pro/Info.plist"

echo "Pre-build complete"
```

---

## Environment Variables

Set these in Xcode Cloud workflow configuration:

- `FASTLANE_APPLE_ID`: Your Apple ID
- `MATCH_PASSWORD`: Fastlane Match password (for cert management)
- `SLACK_URL`: Webhook for notifications (optional)

**Note:** Secrets should be configured in Xcode Cloud UI, not committed to repository.

---

## Compute Hour Estimates

**Monthly Free Tier:** 25 hours

**Estimated Usage:**
- PR Validation: ~15 min × 20 PRs/month = 5 hours
- Main Branch Build: ~25 min × 30 commits/month = 12.5 hours
- Nightly Build: ~60 min × 30 days = 30 hours (exceeds free tier)
- Release Build: ~40 min × 2 releases/month = 1.3 hours

**Total Estimated:** ~48.8 hours/month
**Recommendation:** Disable nightly builds or reduce to weekly (saves 22.5 hours)

---

## Migration from GitHub Actions

Current `.github/workflows/beta.yml` can be replaced/supplemented:

**Option A: Full Migration**
- Remove GitHub Actions workflow
- Use Xcode Cloud for all builds

**Option B: Hybrid Approach**
- Keep GitHub Actions for PR checks (free for public repos)
- Use Xcode Cloud for TestFlight deployments

**Recommendation:** Hybrid approach to maximize free tiers

---

## Monitoring & Notifications

Configure notifications in Xcode Cloud:
1. Email notifications (success/failure)
2. Slack integration (webhook)
3. GitHub status checks (auto-configured)

---

## References

- [Xcode Cloud Overview](https://developer.apple.com/xcode-cloud/)
- [Getting Started Guide](https://developer.apple.com/xcode-cloud/get-started/)
- [Workflow Configuration Docs](https://developer.apple.com/documentation/xcode/configuring-your-first-xcode-cloud-workflow)
- [CI/CD Best Practices](https://www.xavor.com/blog/xcode-cloud-for-ci-cd/)

---

**Last Updated:** November 30, 2025
**Next Review:** After v1.2 launch
