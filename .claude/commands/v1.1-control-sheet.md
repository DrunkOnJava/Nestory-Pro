# v1.1 Control Sheet - Execution Plan

Use these tables as your execution plan. Assume multi-agent docs + governance + TODO cleanups are implemented. Re-verify quickly, then move into v1.1 implementation.

For every row:
- Re-open and review all listed files for 100% completion (no TODOs, no drift)
- Make small, atomic commits
- Use askuserquestions tool for uncertainty, especially pricing, roadmap changes, or orphaned code

---

## Table 0 - Session Meta-Rules

| # | Aspect | Rules | When to askuserquestions | Done Criteria |
|---|--------|-------|--------------------------|---------------|
| 0.1 | Ground truth | Treat TODO.md + PRODUCT-SPEC.md + CLAUDE.md as canonical. AGENTS.md describes ecosystem; TODO-COMPLETE.md is v1.0 history. | If contradictions found between files, ask which wins instead of silently fixing. | Note which file was source of truth and why. |
| 0.2 | 100% completion | For every step, re-open and review every listed file ensuring change is complete (no half-migrated code, stale comments, outdated examples). | When unsure if change needs follow-up in another file. | List: "For this step I touched: X, Y, Z. All now consistent." |
| 0.3 | Pricing & roadmap | May not directly change prices, tier names, or feature assignments without asking. May evaluate and propose. | When adjusting pricing, tiers, or version targets, propose and wait for approval. | Changes happen only after explicit approval. |
| 0.4 | Orphaned code | Never delete or re-home orphaned files silently. Propose integration/deletion strategy first. | When detecting unreferenced files (obsolete experiments), ask to integrate, archive, or remove. | Short "orphaned code" section noting findings and decisions. |
| 0.5 | Scope of autonomy | Free to refactor within MVVM + services and v1.1 scope. Don't spontaneously invent v2.x/v3.x features. | Any time tempted to implement beyond v1.1 or TODO.md scope. | v1.1 work grounded in existing tasks; no surprise features. |
| 0.6 | Commit discipline | One logical concern per commit. Descriptive messages. | If change sprawls across multiple areas, pause and ask how to split. | Short list of commits, each with clear purpose. |

---

## Table 1 - Quick Sanity Pass (Verify Previous Work)

| Step | Objective | Files to Check | Actions | When to Ask | Completion |
|------|-----------|----------------|---------|-------------|------------|
| 1.1 | Verify agent doc ecosystem coherent | AGENTS.md, CLAUDE.md, GEMINI.md, COPILOT.md, WARP.md | Confirm each states platform/purpose. All reference CLAUDE.md governance. Fix typos, broken refs. | If files disagree on rules, ask which wins. | "Agent docs consistent. Governance aligned. No contradictions." |
| 1.2 | Confirm TODO/COMPLETE/Key Decisions/Testing | TODO.md, TODO-COMPLETE.md | Ensure Key Decisions include reasons. Check Testing Requirements mention both test targets + 60% baseline. Pricing guardrail text present. | If Key Decision outdated, ask and propose updated reasoning. | Tail section internally consistent, matches reality. |
| 1.3 | Validate v1.1-v3.0 roadmap & counts | TODO.md, PRODUCT-SPEC.md, README.md | Confirm version table matches spec descriptions. "Total pending tasks" matches real count or marked approximate. | If mismatches, ask whether to update spec or TODO. | Versions + themes + pricing tiers align; counts not lying. |

---

## Table 2 - v1.1 Planning Pass

| Step | Objective | Files | Actions | When to Ask | Completion |
|------|-----------|-------|---------|-------------|------------|
| 2.1 | Enumerate all v1.1 tasks | TODO.md (v1.1 section) | List all v1.1 tasks with IDs (P1-xx, 9.3.x). Note if doc-only, code, or tests. | If descriptions ambiguous, ask how to interpret. | Explicit v1.1 task list with IDs, agreed via askuserquestions. |
| 2.2 | Map tasks to code areas | Nestory-Pro.xcodeproj, Sources/**, ViewModels/**, Services/**, Tests/** | For each task, list modules/files touched. Identify surprise dependencies. | If tasks require new modules not in TODO, ask whether to introduce now. | Matrix: P1-00 -> Xcode project + Tests/Support/SnapshotHelpers.swift, etc. |
| 2.3 | Choose implementation order | TODO.md, 2.1/2.2 list | Propose execution order (e.g., P1-00 snapshot -> P1-03 Swift 6 -> 9.3.x snapshots -> CloudKit). | Run askuserquestions to confirm order. | Agreed order referenced in later messages. |

---

## Table 3 - Track A: Snapshot Testing Foundations

| Step | Objective | Files | Actions | When to Ask | Completion |
|------|-----------|-------|---------|-------------|------------|
| 3.1 | Add snapshot dependency (P1-00) | Xcode project, Package.swift, test configs, TODO.md | Add swift-snapshot-testing to test target. Ensure builds. Update TODO.md P1-00 status. | Ask before choosing library if ambiguous. Confirm directory structure. | Tests compile with snapshot lib; TODO reflects P1-00 done, 9.3.x unblocked. |
| 3.2 | Create helpers & directory structure | Nestory-ProTests/**, SnapshotHelpers.swift | Add helper file for snapshot setup. Standardize baseline paths. Document usage in CLAUDE.md. | If folder layout unclear, ask how strict. | Helper utility exists with clear pattern for other tests. |
| 3.3 | Implement 9.3.1-9.3.4 snapshot tests | TODO.md (9.3.x), views: Inventory list, Item detail, Paywall, Reports | Create snapshot test per 9.3.x producing baseline. Ensure stable on CI. | Ask about tolerated flakiness. | All 9.3.x have test files and passing snapshots. TODO updated. |

---

## Table 4 - Track B: Swift 6 Migration

| Step | Objective | Files | Actions | When to Ask | Completion |
|------|-----------|-------|---------|-------------|------------|
| 4.1 | Inventory Swift 6 warnings | Build logs, TODO.md P1-03 | Build with strict concurrency flags. Collect warnings grouped by module. | Ask how aggressive: @MainActor vs actors vs minimal. | Categorized warning list: "InventoryVM: 7, ItemStorage: 5, ..." |
| 4.2 | Design migration strategy | PRODUCT-SPEC.md, warning list | Propose ordered migration: e.g., UI types first, then services. | Get buy-in via askuserquestions. | Signed-off plan: "Pass 1: ViewModels; Pass 2: Storage; Pass 3: CloudKit" |
| 4.3 | Apply changes to first area | Targeted subset (one ViewModel + tests) | Add @MainActor, Sendable, actors in agreed scope. Update tests. | If refactor cascades, stop and ask to broaden or split. | One region migrated, tests passing, warnings reduced. |
| 4.4 | Iterate to next area | Next group per strategy | Repeat 4.3. Keep TODO.md updated. | Ask if time to flip target to Swift 6 mode. | Warnings decreasing; no regressions; controlled migration. |

---

## Table 5 - Track C: CloudKit Readiness

| Step | Objective | Files | Actions | When to Ask | Completion |
|------|-----------|-------|---------|-------------|------------|
| 5.1 | Reconcile CloudKit decisions | TODO.md, PRODUCT-SPEC.md, CloudKitService | Confirm v1.0 local-only, v1.1 readiness in docs. Check feature flags/guards. | If CloudKit should be delayed/enabled differently, ask and propose. | "Current state: X; v1.1 goal: Y; code matches or corrected." |
| 5.2 | Implement readiness toggles | Sync services, FeatureFlags, AppConfig | Add/refine central sync state/feature flag. Enable CloudKit in one config place. | Ask how to expose (internal flag vs user-facing toggle). | Single obvious place to enable CloudKit; no hidden toggles. |
| 5.3 | Add CloudKit boundary tests | Sync service tests | Tests validating: CloudKit off = no network calls; on = correct adapter invoked. | Ask about mocking vs real CloudKit in dev/test. | Test suite proves readiness behaves as designed; TODO updated. |

---

## Table 6 - Verification & Regression

| Step | Objective | Files/Tools | Actions | When to Ask | Completion |
|------|-----------|-------------|---------|-------------|------------|
| 6.1 | Run full test suite | fastlane/Fastfile, test targets, CI YAML | Run full pipeline. Fix failures from snapshot/Swift 6/CloudKit work. | If failures flaky or pre-existing, ask to stabilize or document. | "All tests passing" or documented known pre-existing failures. |
| 6.2 | Documentation sync | README.md, PRODUCT-SPEC.md, TODO.md, CLAUDE.md | Update docs where behavior changed. Check cross-doc links. | Ask if marketing language changes wanted vs strictly technical. | Docs accurately describe v1.1 work; no stale sections. |
| 6.3 | Tag + handoff note | git, TODO.md Changelog | Propose tag name (e.g., v1.1-foundation). Add Changelog entry. | Confirm tag name and whether to push via askuserquestions. | Tag created (if approved); summary ready for next work wave. |

---

## Table 7 - Orphaned Code Protocol (Standing Rule)

| Rule | Scenario | Required Behavior | askuserquestions Usage | Outcome |
|------|----------|-------------------|------------------------|---------|
| OC-1 | View/ViewModel not referenced | Do not delete. Propose: (a) integrate into planned feature, or (b) archive to "experimental". | Ask how to handle; suggest concrete plan. | Integrated and tested, or parked with TODO.md note. |
| OC-2 | Tests don't match current behavior | Investigate why. Suggest refactor/update or deprecation. | Ask if tests represent behavior we care about. | Tests aligned with current behavior or marked deprecated with approval. |
| OC-3 | Duplicate helpers/services | Propose consolidation (which version canonical). Implement after approval. | Use askuserquestions with before/after sketch. | Single well-named helper; references updated; tests passing. |

---

## Current Session Progress

### Completed
- [x] Table 1: Sanity pass - Agent docs, TODO structure, roadmap validated
- [x] Table 2: v1.1 tasks enumerated and mapped to code surfaces
- [x] P1-04: Background modes & entitlements cleanup (removed unused UIBackgroundModes, aps-environment)
- [x] Table 3.2: Snapshot helpers created (`SnapshotHelpers.swift`)
- [x] Table 4.1: Swift 6 warnings inventory (xcconfig prepared, pending attachment)
- [x] Table 5.1: CloudKit readiness confirmed (monitoring + toggle in place)
- [x] Table 6.1: Full test suite run - ConcurrencyTests pass (52.957 sec)
- [x] Table 6.2: Documentation sync - TODO.md, PRODUCT-SPEC.md, README.md consistent
- [x] Fix TestFixtures.swift crash - Changed to NestoryModelContainer.createForTesting()
- [x] **XcodeGen Implementation** - Eliminated all manual Xcode steps ✓ 2025-11-29
  - Created `project.yml` as single source of truth for project configuration
  - Created `Scripts/regenerate_project.sh` helper script
  - All blockers resolved via declarative project generation
- [x] **P1-00**: swift-snapshot-testing package ✓ 2025-11-29 (via XcodeGen)
- [x] **P1-01**: xcconfig-based build settings ✓ 2025-11-29 (via XcodeGen)
- [x] **P1-02**: Beta configuration & scheme ✓ 2025-11-29 (via XcodeGen)
- [x] **Info.plist fix**: Added required CFBundle* keys ✓ 2025-11-29

### Now Unblocked (Ready for Implementation)
- [ ] 9.3.1-9.3.4: Snapshot tests (P1-00 complete)
- [~] P1-03: Swift 6 migration (P1-01 complete, settings active)
- [ ] Table 4.2-4.4: Swift 6 migration execution

### Files Created This Session
- `Config/Common.xcconfig` - Central build settings (Swift 6, strict concurrency)
- `Config/Debug.xcconfig` - Debug with Thread Sanitizer, Main Thread Checker
- `Config/Beta.xcconfig` - TestFlight optimized
- `Config/Release.xcconfig` - App Store full optimization
- `Config/Tests.xcconfig` - Test target config (no MainActor default)
- `Config/UITests.xcconfig` - UI test config (no MainActor default)
- `Nestory-ProTests/SnapshotTests/SnapshotHelpers.swift` - Snapshot testing infrastructure
- `Nestory-ProTests/SnapshotTests/ViewSnapshotTests.swift` - 9.3.1-9.3.4 snapshot tests
- `project.yml` - XcodeGen manifest (single source of truth)
- `Scripts/regenerate_project.sh` - Project regeneration helper

### Files Modified This Session
- `Nestory-Pro/Info.plist` - Added required CFBundle* keys for bundle ID
- `Nestory-Pro/Nestory_Pro.entitlements` - Removed aps-environment
- `Nestory-ProTests/TestFixtures.swift` - Fixed TestContainer.empty() to use NestoryModelContainer
- `TODO.md` - Updated P1-00, P1-01, P1-02 complete; P1-03 in progress
- `CLAUDE.md` - Added XcodeGen section and snapshot testing docs
- `WARP.md` - Added xcconfig documentation

### Known Issues - RESOLVED
- **TestFixtures.swift crash**: FIXED - now uses NestoryModelContainer.createForTesting()

---

## Analysis Results

### Table 4.1 - Swift 6 Warnings Inventory
- **xcconfig files prepared** with SWIFT_STRICT_CONCURRENCY = complete
- **NOT YET ACTIVE** - xcconfig files need to be attached to Xcode project (manual step)
- **Current build**: Clean (using project's existing settings, not xcconfig)
- **Action needed**: Attach xcconfig files in Xcode, then rebuild to see warnings

### Table 5.1 - CloudKit Readiness Status
- **Infrastructure**: CloudKitSyncMonitor.swift exists (debug logging, status tracking)
- **Entitlements**: iCloud.com.drunkonjava.nestory container configured
- **Toggle ready**: NestoryModelContainer.create(cloudKit: false) parameter
- **v1.0 state**: Local-only (cloudKit = false)
- **v1.1 goal**: Readiness (monitoring in place, toggle ready) - ACHIEVED
- **Conclusion**: CloudKit readiness is complete for v1.1; activation for v1.2+

---

## Manual Steps Required (Xcode)

1. **P1-00**: Add swift-snapshot-testing package
   - File > Add Package Dependencies
   - URL: https://github.com/pointfreeco/swift-snapshot-testing
   - Add to: Nestory-ProTests target

2. **P1-01**: Attach xcconfig files to project
   - Project > Info > Configurations
   - Set Debug/Release/Beta to use Config/*.xcconfig files
   - Rebuild to verify Swift 6 warnings appear

---

## Table 6.3 - Handoff Note (2025-11-29)

### Session Summary

This session completed the preparatory work for v1.1 implementation. All automated tasks are complete; remaining work requires manual Xcode UI actions.

### What Was Accomplished

| Category | Item | Status |
|----------|------|--------|
| **Infrastructure** | TestFixtures.swift crash fix | ✅ Fixed |
| **Infrastructure** | xcconfig files (5 files) | ✅ Created |
| **Infrastructure** | SnapshotHelpers.swift | ✅ Created |
| **Entitlements** | P1-04 cleanup | ✅ Complete |
| **CloudKit** | Readiness verification | ✅ Confirmed |
| **Documentation** | TODO.md, PRODUCT-SPEC.md, README.md | ✅ Synced |
| **Testing** | ConcurrencyTests | ✅ Passing (52.957s) |

### What Requires Manual Action

**Two Xcode UI steps are blocking v1.1 progress:**

#### 1. Add swift-snapshot-testing Package (P1-00)
```
File > Add Package Dependencies
URL: https://github.com/pointfreeco/swift-snapshot-testing
Target: Nestory-ProTests
```
**Unblocks:** 9.3.1-9.3.4 snapshot tests

#### 2. Attach xcconfig Files (P1-01)
```
Project > Nestory-Pro > Info > Configurations
- Debug: Config/Debug.xcconfig
- Release: Config/Release.xcconfig
- (Create Beta config and assign Config/Beta.xcconfig)
```
**Unblocks:** P1-02, P1-03 (Swift 6 migration), Beta scheme

### Post-Manual Steps Roadmap

After completing the manual Xcode steps:

1. **Rebuild** with new xcconfig → Capture Swift 6 strict concurrency warnings
2. **Design migration strategy** (Table 4.2) → Propose ViewModels → Services → CloudKit order
3. **Implement snapshot tests** (9.3.1-9.3.4) → Inventory list, Item detail, Paywall, Reports
4. **Swift 6 migration** (P1-03) → Apply @MainActor, Sendable, actors per strategy
5. **Create Beta scheme** (P1-02) → Duplicate Release, bind to Beta xcconfig

### Test Results Summary

- **ConcurrencyTests**: 12 tests, 52.957 sec, **PASSED**
- **Build status**: Clean (no errors)
- **TestFixtures**: Working with NestoryModelContainer.createForTesting()

### Files Changed This Session

**Created:**
- `.claude/commands/v1.1-control-sheet.md`
- `Config/Common.xcconfig`
- `Config/Debug.xcconfig`
- `Config/Beta.xcconfig`
- `Config/Release.xcconfig`
- `Config/Tests.xcconfig`
- `Nestory-ProTests/SnapshotTests/SnapshotHelpers.swift`

**Modified:**
- `Nestory-Pro/Info.plist` (removed UIBackgroundModes)
- `Nestory-Pro/Nestory_Pro.entitlements` (removed aps-environment)
- `Nestory-ProTests/TestFixtures.swift` (fixed container creation)
- `TODO.md` (updated v1.1 progress)
- `CLAUDE.md` (added snapshot testing section)
- `WARP.md` (added xcconfig documentation)

### Suggested Tag

Once manual steps complete and Swift 6 migration begins:
- **Tag name**: `v1.1-foundation`
- **Description**: "v1.1 foundation: xcconfig, snapshot infrastructure, entitlements cleanup"

---

*Generated: 2025-11-29 | Session: v1.1 Control Sheet Execution*
